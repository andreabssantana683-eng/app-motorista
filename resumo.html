<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Resumo - Motorista App</title>
<style>
/* bottom menu */
.bottom-menu{
    position:fixed;
    bottom:15px;
    left:50%;
    transform:translateX(-50%);
    width:88%;
    background:#1B1B1B;
    padding:10px 0;
    border-radius:18px;
    display:flex;
    justify-content:space-around;
    box-shadow:0 6px 25px rgba(0,0,0,0.6);
    z-index:1000;
}
.bottom-menu .menu-item{
    text-align:center;
    color:#fff;
    text-decoration:none;
    font-size:13px;
    display:flex;
    flex-direction:column;
    align-items:center;
}
.bottom-menu .menu-item .icon{
    font-size:22px;
    margin-bottom:4px;
}
.bottom-menu .menu-item.active{
    color:var(--accent);
}
:root{
  --bg:#121212; --card:#1E1E1E; --panel:#2A2A2A; --accent:#1DB954; --danger:#ff3b30; --muted:#bbb;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:#fff;padding-bottom:140px;}
header{background:var(--accent);padding:14px;text-align:center;color:#000;font-weight:700;font-size:20px;}
.container{max-width:1100px;margin:12px auto;padding:16px;}
.top-summary{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;}
.badge{background:var(--card);padding:12px;border-radius:10px;min-width:160px;text-align:center;box-shadow:0 6px 16px rgba(0,0,0,0.5);}
.badge .label{color:var(--muted);font-size:13px}
.badge .value{font-size:20px;font-weight:800;margin-top:6px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:800;cursor:pointer}
.btn.ghost{background:#333;color:#fff}
.section{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.5);}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:260px}
.table{width:100%;border-collapse:collapse}
.table th{background:#1b1b1b;color:var(--muted);padding:8px;text-align:left;font-weight:700}
.table td{padding:8px;border-top:1px solid #222}
.small{color:var(--muted);font-size:13px}
.kpi{display:flex;gap:8px;align-items:center;justify-content:space-between}
.kpi .num{font-weight:800;font-size:18px}
.exportRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.note{color:var(--muted);font-size:13px;margin-top:8px}

/* responsive */
@media(max-width:820px){
  .top-summary{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>
<header>Resumo</header>
<div class="container">

  <!-- TOP: quick balances -->
  <div class="top-summary">
    <div class="badge">
      <div class="label">Dinheiro (em m√£o)</div>
      <div id="balDinheiro" class="value">R$ 0,00</div>
    </div>

    <div class="badge">
      <div class="label">Pix (inclui cart√£o e pagamentos no app)</div>
      <div id="balPix" class="value">R$ 0,00</div>
    </div>

    <div class="badge">
      <div class="label">Cart√£o (total registrado)</div>
      <div id="balCartao" class="value">R$ 0,00</div>
    </div>

    <div class="badge">
      <div class="label">Dias trabalhados / faltam</div>
      <div id="diasInfo" class="value">0 / 0</div>
    </div>
  </div>

  <div class="controls">
    <button id="reloadBtn" class="btn ghost">Atualizar</button>
    <button id="exportWhatsBtn" class="btn">Enviar por WhatsApp</button>
    <button id="exportPdfBtn" class="btn">Gerar PDF</button>
    <select id="periodSelect" class="ghost" style="padding:10px;border-radius:10px;background:#222;color:#fff;border:none">
      <option value="diario">Di√°rio (hoje)</option>
      <option value="semanal">Semanal (semana atual)</option>
      <option value="mensal" selected>Mensal (m√™s atual)</option>
    </select>
  </div>

  <!-- Summary KPIs for selected period -->
  <div id="periodSection" class="section">
    <div class="row">
      <div class="col">
        <div class="kpi"><div><div class="small">Faturamento (bruto)</div><div id="k_fat" class="num">R$ 0,00</div></div><div class="small">Qtd viagens: <span id="k_qt_viagens">0</span></div></div>
      </div>
      <div class="col">
        <div class="kpi"><div><div class="small">Despesas</div><div id="k_desp" class="num">R$ 0,00</div></div><div class="small">Entradas extras: <span id="k_qt_outras">0</span></div></div>
      </div>
      <div class="col">
        <div class="kpi"><div><div class="small">Lucro L√≠quido</div><div id="k_lucro" class="num">R$ 0,00</div></div><div class="small">Taxa m√©dia (estim): <span id="k_taxa">0%</span></div></div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="small">Total por forma de pagamento</div>
      <table class="table" style="margin-top:8px">
        <thead><tr><th>Forma</th><th>Valor</th></tr></thead>
        <tbody id="payBreakdown">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>

    <div style="margin-top:12px;">
      <div class="small">Resumo por tipo de entrada</div>
      <table class="table" style="margin-top:8px">
        <thead><tr><th>Tipo</th><th>Valor</th><th>Qtd</th></tr></thead>
        <tbody id="typeBreakdown"></tbody>
      </table>
    </div>
  </div>

  <!-- Detalhes: viagens por app -->
  <div class="section">
    <h3>Viagens por aplicativo / tipo</h3>
    <div class="row">
      <div class="col">
        <table class="table">
          <thead><tr><th>App / Tipo</th><th>Valor</th><th>Qtd</th></tr></thead>
          <tbody id="appsTable"></tbody>
        </table>
      </div>

      <div class="col">
        <div class="small">Detalhes finais</div>
        <div style="margin-top:8px">
          <div class="small">Total de viagens (per√≠odo): <strong id="totalViagens">0</strong></div>
          <div class="small">Dias trabalhados (m√™s atual): <strong id="diasTrabalhados">0</strong></div>
          <div class="small">Dias restantes no m√™s: <strong id="diasRestantes">0</strong></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista resumida de registros (opcional) -->
  <div class="section">
    <h3>Registros (resumido)</h3>
    <table class="table">
      <thead><tr><th>Data</th><th>Tipo</th><th>Forma</th><th>App/Detalhe</th><th>Bruto</th><th>L√≠quido</th></tr></thead>
      <tbody id="listResumo"></tbody>
    </table>
    <div class="note">Os filtros di√°rio/semana/m√™s seguem a data atual do dispositivo.</div>
  </div>

</div>

<!-- libs para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/*
  Resumo page script
  - suporta registros em localStorage:
    - chave 'entradasSaidas' (array)
    - opcional: 'viagens' (array)
  - formato esperado por registro (flex√≠vel):
    {
      id, tipo: 'entrada'|'saida', subtipo, formaPag: 'dinheiro'|'pix'|'cartao'|'appMobile'|'a_receber'|..., 
      valorBruto, valor (l√≠quido), descricao, appTipo: 'uber'|'99'|'indriver'| 'particular'|'empresa', criadoEm: ISOstring
    }
*/

const $ = id => document.getElementById(id);
const fmt = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

// load arrays robustly
function loadRecords(){
  let registros = [];
  try { registros = JSON.parse(localStorage.getItem('entradasSaidas') || '[]'); } catch(e){ registros = []; }
  // if there's a separate 'viagens' array, merge it if present
  try {
    const viagens = JSON.parse(localStorage.getItem('viagens') || 'null');
    if(Array.isArray(viagens)) {
      // ensure itens t√™m 'tipo'
      viagens.forEach(v => {
        if(!v.tipo) v.tipo = 'entrada';
        registros.push(v);
      });
    }
  } catch(e){}
  // normalize dates and fields
  registros = registros.map(r => {
    // some records might have 'date' instead of 'criadoEm'
    if(!r.criadoEm && r.date) r.criadoEm = r.date;
    // ensure numeric
    r.valor = Number(r.valor || r.valorLiquido || r.liquido || 0);
    r.valorBruto = Number(r.valorBruto || r.bruto || r.valorBruto || r.valor || 0);
    r.formaPag = r.formaPag || r.formapag || (r.typePayment) || '';
    r.appTipo = r.appTipo || r.app || r.aplicativo || null;
    return r;
  });
  return registros;
}

// date helpers
function isSameDay(d1,d2){
  return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate();
}
function isSameWeek(d, ref){
  // week start monday
  const getMonday = dt => {
    const day = dt.getDay();
    const diff = dt.getDate() - ((day + 6) % 7); // shift so monday=0
    return new Date(dt.getFullYear(), dt.getMonth(), diff);
  };
  const mondayRef = getMonday(ref);
  const sundayRef = new Date(mondayRef); sundayRef.setDate(mondayRef.getDate() + 6);
  return d >= new Date(mondayRef.setHours(0,0,0,0)) && d <= new Date(sundayRef.setHours(23,59,59,999));
}
function isSameMonth(d,ref){ return d.getFullYear()===ref.getFullYear() && d.getMonth()===ref.getMonth(); }

function diasNoMes(date){
  return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
}
function diasRestantesNoMes(){
  const hoje = new Date();
  const ultimo = diasNoMes(hoje);
  return Math.max(0, ultimo - hoje.getDate());
}

// core aggregations
function aggregate(period){ // period: 'diario'|'semanal'|'mensal'
  const registros = loadRecords();
  const now = new Date();
  let filtered = registros.filter(r => r.criadoEm); // we'll parse criadoEm
  filtered = filtered.map(r => {
    r._d = r.criadoEm ? new Date(r.criadoEm) : null;
    return r;
  }).filter(r => r._d); // keep those with date

  // filter by period
  filtered = filtered.filter(r => {
    if(period==='diario') return isSameDay(r._d, now);
    if(period==='semanal') return isSameWeek(r._d, now);
    if(period==='mensal') return isSameMonth(r._d, now);
    return true;
  });

  const summary = {
    faturamentoBruto:0,
    despesas:0,
    lucro:0,
    qtdViagens:0,
    pay: { dinheiro:0, pix:0, cartao:0, appMobile:0, outras:0 },
    typeTotals: {}, // entradas por tipo/subtipo
    apps: {}, // por appTipo
    records: filtered
  };

  filtered.forEach(r=>{
    // entradas
    if(r.tipo === 'entrada'){
      summary.faturamentoBruto += Number(r.valorBruto || r.valor || 0);
      // count viagem-like entries: consider subtipo 'corrida' or presence of appTipo or category
      const isViagem = (r.subtipo && r.subtipo.toLowerCase().includes('corrida')) || r.appTipo || r.categoria === 'particular' || r.categoria === 'empresa' || r.categoria === 'app';
      if(isViagem) summary.qtdViagens++;

      // payment breakdown
      const forma = (r.formaPag || '').toString().toLowerCase();
      const valBr = Number(r.valorBruto || r.valor || 0);
      // User asked: consider card and viagens pg pelo app as pix in that specific top summary.
      // For period breakdown we'll record actual formaPag counts but also populate pixAggregate later if needed.
      if(forma.includes('dinheiro')) summary.pay.dinheiro += valBr;
      else if(forma.includes('pix')) summary.pay.pix += valBr;
      else if(forma.includes('cartao') || forma.includes('cart√£o')) summary.pay.cartao += valBr;
      else if(forma.includes('app') || forma.includes('appmobile') || forma.includes('app_mobile') || forma.includes('appmobile')) summary.pay.appMobile += valBr;
      else summary.pay.outras += valBr;

      // type totals (particular / empresa / app / outras)
      const tipoKey = r.appTipo ? (r.appTipo.toString().toLowerCase()) : (r.categoria ? r.categoria.toString().toLowerCase() : (r.subtipo? r.subtipo.toString().toLowerCase() : 'outras'));
      if(!summary.typeTotals[tipoKey]) summary.typeTotals[tipoKey] = { valor:0, qtd:0 };
      summary.typeTotals[tipoKey].valor += Number(r.valor || r.valorBruto || 0);
      summary.typeTotals[tipoKey].qtd += 1;

      // apps details
      const appKey = r.appTipo ? r.appTipo.toString().toLowerCase() : (r.categoria ? r.categoria.toString().toLowerCase() : 'outras');
      if(!summary.apps[appKey]) summary.apps[appKey] = { valor:0, qtd:0 };
      summary.apps[appKey].valor += Number(r.valor || r.valorBruto || 0);
      summary.apps[appKey].qtd += 1;
    } else if(r.tipo === 'saida'){
      summary.despesas += Number(r.valor || 0);
    }
  });

  summary.lucro = summary.faturamentoBruto - summary.despesas;
  return summary;
}

// breakdown by payment types for display (prefer show bruto & l√≠quido counts)
function buildPayRows(pay){
  const rows = [];
  rows.push({label:'Dinheiro', value:pay.dinheiro});
  rows.push({label:'PIX', value:pay.pix});
  rows.push({label:'Cart√£o', value:pay.cartao});
  rows.push({label:'Pagamento no App', value:pay.appMobile});
  rows.push({label:'Outras formas', value:pay.outras});
  return rows;
}

// compute top balances: as user requested *Pix includes card and pagamentos pelo app in this specific situation*
function computeTopBalances(){
  const registros = loadRecords();
  const now = new Date();
  // consider only entries of current month (or could be all existing values in entries)
  const atual = registros.filter(r => r._d ? isSameMonth(r._d, now) : (r.criadoEm ? isSameMonth(new Date(r.criadoEm), now) : false));
  // we will compute sums by formaPag
  let dinheiro = 0, pix = 0, cartao = 0, appMobile = 0;
  atual.forEach(r=>{
    const forma = (r.formaPag || '').toString().toLowerCase();
    const valorBr = Number(r.valor || r.valorBruto || 0);
    if(forma.includes('dinheiro')) dinheiro += valorBr;
    else if(forma.includes('pix')) pix += valorBr;
    else if(forma.includes('cartao') || forma.includes('cart√£o')) cartao += valorBr;
    else if(forma.includes('app')) appMobile += valorBr;
    else {
      // unknown, push to pix as fallback? keep in outras
    }
  });
  // Per your instruction: consider card AND viagens pagas pelo app as PIX in this specific top view
  const pixSpecial = pix + cartao + appMobile; // combine
  return { dinheiro, pixSpecial, cartao, pixRaw:pix, appMobile };
}

// helpers to get dias trabalhados (count unique days with at least one entrada in month)
function diasTrabalhadosNoMes(){
  const registros = loadRecords();
  const now = new Date();
  const dias = new Set();
  registros.forEach(r=>{
    if(r.tipo==='entrada' && r.criadoEm){
      const d = new Date(r.criadoEm);
      if(isSameMonth(d, now)) dias.add(d.toDateString());
    }
  });
  return dias.size;
}

// render UI for a given period
function render(period){
  const sum = aggregate(period);
  // KPIs
  $('k_fat').innerText = fmt(sum.faturamentoBruto);
  $('k_desp').innerText = fmt(sum.despesas);
  $('k_lucro').innerText = fmt(sum.lucro);
  $('k_qt_viagens').innerText = sum.qtdViagens;
  // simple estimated taxa: (bruto - liquido)/bruto
  const taxa = sum.faturamentoBruto ? Math.round(((sum.faturamentoBruto - (sum.lucro + sum.despesas)) / sum.faturamentoBruto)*100) : 0;
  $('k_taxa').innerText = isFinite(taxa)? taxa + '%' : '0%';
  $('k_qt_outras').innerText = (Object.keys(sum.typeTotals).reduce((acc,k)=> acc + (k==='outras'? sum.typeTotals[k].qtd:0),0));

  // payment breakdown
  const payRows = buildPayRows(sum.pay);
  const payBody = payRows.map(r => `<tr><td>${r.label}</td><td>${fmt(r.value)}</td></tr>`).join('');
  $('payBreakdown').innerHTML = payBody;

  // type breakdown
  const types = Object.keys(sum.typeTotals).map(k => {
    const it = sum.typeTotals[k];
    return `<tr><td>${k}</td><td>${fmt(it.valor)}</td><td>${it.qtd}</td></tr>`;
  }).join('');
  $('typeBreakdown').innerHTML = types || '<tr><td colspan="3" class="small">Sem registros</td></tr>';

  // apps table
  const apps = Object.keys(sum.apps).map(k => {
    const it = sum.apps[k];
    return `<tr><td>${k}</td><td>${fmt(it.valor)}</td><td>${it.qtd}</td></tr>`;
  }).join('');
  $('appsTable').innerHTML = apps || '<tr><td colspan="3" class="small">Sem viagens</td></tr>';

  // totals
  $('totalViagens').innerText = sum.qtdViagens;
  $('listResumo').innerHTML = sum.records.slice(0,200).map(r=>{
    const dt = r._d ? r._d.toLocaleString() : (r.criadoEm ? new Date(r.criadoEm).toLocaleString() : '');
    return `<tr><td>${dt}</td><td>${r.tipo}${r.subtipo?(' / '+r.subtipo):''}</td><td>${r.formaPag||''}</td><td>${r.appTipo||r.categoria||''}</td><td>${fmt(r.valorBruto)}</td><td>${fmt(r.valor)}</td></tr>`;
  }).join('') || '<tr><td colspan="6" class="small">Sem registros</td></tr>';

  // top balances & days
  const top = computeTopBalances();
  $('balDinheiro').innerText = fmt(top.dinheiro);
  // pixSpecial: pix + cartao + appMobile per your instruction
  $('balPix').innerText = fmt(top.pixSpecial);
  $('balCartao').innerText = fmt(top.cartao);

  const diasTrab = diasTrabalhadosNoMes();
  $('diasTrabalhados').innerText = diasTrab;
  const restantes = diasRestantesNoMes();
  $('diasRestantes').innerText = restantes;
  $('diasInfo').innerText = `${diasTrab} / ${restantes}`;

}

// export / whatsapp
function exportWhats(period){
  // builds a compact textual report for current period (period param)
  const sum = aggregate(period);
  const now = new Date();
  const title = period==='diario' ? `Relat√≥rio Di√°rio (${now.toLocaleDateString()})` : (period==='semanal' ? `Relat√≥rio Semanal (semana de ${now.toLocaleDateString()})` : `Relat√≥rio Mensal (${now.toLocaleString('pt-BR',{month:'long',year:'numeric'})})`);
  let msg = `${title}\n\n`;
  msg += `Faturamento (bruto): ${fmt(sum.faturamentoBruto)}\n`;
  msg += `Despesas: ${fmt(sum.despesas)}\n`;
  msg += `Lucro l√≠quido: ${fmt(sum.lucro)}\n\n`;

  msg += `Formas de pagamento:\n`;
  const payRows = buildPayRows(sum.pay);
  payRows.forEach(p => msg += ` - ${p.label}: ${fmt(p.value)}\n`);

  msg += `\nViagens: ${sum.qtdViagens}\n`;
  msg += `Por app / tipo:\n`;
  Object.keys(sum.apps).forEach(k => {
    msg += ` - ${k}: ${fmt(sum.apps[k].valor)} (qtd ${sum.apps[k].qtd})\n`;
  });

  // open whatsapp (uses wa.me)
  const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

// PDF export (whole page summary area)
async function exportPdf(){
  try {
    // prefer to capture container
    const el = document.querySelector('.container');
    // clone and append offscreen to ensure consistent width
    const clone = el.cloneNode(true);
    clone.style.width = '1000px';
    const wrapper = document.createElement('div');
    wrapper.style.position = 'fixed';
    wrapper.style.left = '-9999px';
    wrapper.appendChild(clone);
    document.body.appendChild(wrapper);

    const canvas = await html2canvas(clone, { scale:2, backgroundColor: '#121212', useCORS:true });
    document.body.removeChild(wrapper);

    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgProps = pdf.getImageProperties(imgData);
    const imgWidth = pageWidth;
    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

    if(imgHeight <= pdf.internal.pageSize.getHeight()){
      pdf.addImage(imgData,'PNG',0,0,imgWidth,imgHeight);
    } else {
      // scale to width and split into pages by slicing canvas
      const pageHeightPixels = Math.round(canvas.width * (pdf.internal.pageSize.getHeight() / imgWidth));
      let y = 0;
      while(y < canvas.height){
        const partCanvas = document.createElement('canvas');
        partCanvas.width = canvas.width;
        partCanvas.height = Math.min(pageHeightPixels, canvas.height - y);
        const ctx = partCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, y, canvas.width, partCanvas.height, 0, 0, canvas.width, partCanvas.height);
        const partData = partCanvas.toDataURL('image/png');
        const partImgHeight = (partCanvas.height * imgWidth) / canvas.width;
        pdf.addImage(partData, 'PNG', 0, 0, imgWidth, partImgHeight);
        y += pageHeightPixels;
        if(y < canvas.height) pdf.addPage();
      }
    }
    const filename = `resumo_${new Date().toISOString().slice(0,10)}.pdf`;
    pdf.save(filename);
  } catch(err){
    console.error(err);
    alert('Erro ao gerar PDF: ' + (err.message || err));
  }
}

// UI bindings
$('reloadBtn').addEventListener('click', ()=> render($('periodSelect').value));
$('periodSelect').addEventListener('change', ()=> render($('periodSelect').value));
$('exportWhatsBtn').addEventListener('click', ()=> exportWhats($('periodSelect').value));
$('exportPdfBtn').addEventListener('click', ()=> exportPdf());

// initial render
render('mensal');

</script>
<!-- MENU INFERIOR -->
<nav class="bottom-menu" aria-label="Menu">
    <a href="index.html" class="menu-item">
        <span class="icon">üè†</span>
        <span>Dashboard</span>
    </a>

    <a href="entradas.html" class="menu-item">
        <span class="icon">üíµ</span>
        <span>Entradas</span>
    </a>


    <a href="manutencao.html" class="menu-item">
        <span class="icon">üõ†Ô∏è</span>
        <span>Manuten√ß√£o</span>
    </a>

    <a href="resumo.html" class="menu-item active">
        <span class="icon">üìä</span>
        <span>Resumo</span>
    </a>

    <a href="perfil.html" class="menu-item">
        <span class="icon">üë§</span>
        <span>Perfil</span>
    </a>

    <a href="calculadora.html" class="menu-item">
        <span class="icon">üìü</span>
        <span>Calc</span>
    </a>
</nav>
</body>
</html>
